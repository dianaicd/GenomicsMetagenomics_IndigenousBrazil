---
title: "Supplementary tables for mapping statistics and contamination"
author: "DI Cruz DÃ¡valos"
date: "2/5/2020"
output: 
  html_document:
      toc: true
      toc_float: true
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```

```{r}
require(plyr)
require(ggplot2)
require(cowplot)
require(tidyr)
require(dplyr)
require(scales)
require(knitr)
require(DT)
require(openxlsx)
source("~/Projects/Botocudos/Scripts/DataQuality/functions_excel_tables.R")
source("~/Projects/Botocudos/Scripts/DataQuality/functions_merge_clean_mapping_stats.R")
```

```{r}
#------------------------------------------------------------------------------#
# Load metadata (i.e., Samples names, isotopic data if available)
backbone <- read.csv("~/Projects/Botocudos/Files/Tables/Backbone_Table1_2020.csv", stringsAsFactors = F)
colnames(backbone) <- c("Sample", "Group", "Tissue",
                        "CalibratedDate", "Area", "State") 

```

## Supplementary Table 1:  Mapping stats per sample

```{r merge stats into a single table}
# Whole or Trimmed
data_type <- "Whole"

myPath <- "~/Projects/Botocudos/Files/Summaries/2019_11_21/"
depth_name <- "sample_depth.hg19.csv"
stats_name <- "sample_stats.hg19.csv"

dp <- read.csv( paste( myPath, data_type, "/", 
                       depth_name, sep = "" ),
                stringsAsFactors = F
)
dp$SM <- sub(".hg19", "", dp$Sample)
st <- read.csv( paste( myPath, data_type, "/",
                       stats_name, sep = ""), 
                stringsAsFactors = F
)

myStats <- merge_and_clean_stats(dp, st)

write.csv(myStats, 
          paste("~/Projects/Botocudos/Files/Summaries/2019_11_21/", 
                data_type, "/myStats.csv", sep = ""), 
          row.names = F)
#-----------------------------------------------------------------------------#
# read in column names and description
myColNames <- read.csv("~/Projects/Botocudos/Files/Tables/Caption_ST1.csv",
                       stringsAsFactors = F)
#-----------------------------------------------------------------------------#
# get table with metadata}
myT1 <- stats_to_readable_tables(myStats = myStats, 
                                backbone = backbone,
                                myColNames = myColNames,
                                add_caption = F)
#-----------------------------------------------------------------------------#
# r save to excel with openxlsx
## data.frame to write
# df <- myXL
df <- myT1
column_styles <- list(trim_prop               = list(numFmt = "0.0%"),
                      duplicates_prop         = list(numFmt = "0.0%"),
                      reads_raw               = list(numFmt = "COMMA"),
                      reads_trim              = list(numFmt = "COMMA"),
                      mapping                 = list(numFmt = "COMMA"),
                      duplicates              = list(numFmt = "COMMA"),
                      mapping_final           = list(numFmt = "COMMA"),
                      endo_prop               = list(numFmt = "#0.00%"),
                      endo_final_prop         = list(numFmt = "#0.00%"),
                      DoC_MT                  = list(numFmt = "0.0"),
                      length_reads_endogenous = list(numFmt = "0.0"))

#==============================================================================#
# Make workbook and add sheet
workbook_name <- "~/Projects/Botocudos/Files/Tables/Supplementary_tables.xlsx"
workbook <- createWorkbook()
sheet_name <- paste("Sup_T1_", data_type, sep = "")
caption <- get_caption( myT1 = myT1, myColNames = myColNames )

add_new_sheet(sheet_name = sheet_name, workbook = workbook, header_style = F,
              df = df, column_styles = column_styles,
              caption = caption
              )
## writing as an Excel Table
# openXL(file =  workbook)

```

```{r make a plot, eval = F}
myStats <- myStats[order(myStats$AvgReadDepth_tot),]
stats_to_plot <- myStats %>% 
  mutate(log_reads_raw = log10(reads_raw),
         log_reads_trim = log10(reads_trim),
         log_mapping = log10(mapping),
         log_duplicates = log10(duplicates),
         log_mapping_final = log10(mapping_final),
         log_endo_prop = log10(endo_prop),
         log_endo_final_prop = log10(endo_final_prop)) %>% 
  gather( name, value,  -SM, -low_ry, -high_ry, -Nseqs, 
          -NchrY.NchrX, -NchrY, -SE, -Sex, -X95.CI, -Sample) 

# stats_to_plot$value <- as.numeric(stats_to_plot$value)

stats_to_plot$name <- factor(stats_to_plot$name, levels = c("reads_raw",
                                                            "log_reads_raw",
                                                            "reads_trim",
                                                            "log_reads_trim",
                                                            "trim_prop",
                                                            "mapping",
                                                            "log_mapping",
                                                            "duplicates",
                                                            "log_duplicates",
                                                            "duplicates_prop",
                                                            "mapping_final",
                                                            "log_mapping_final",
                                                            "R_y",
                                                            "endo_prop",
                                                            "log_endo_prop",
                                                            "endo_final_prop",
                                                            "log_endo_final_prop",
                                                            "AvgReadDepth_tot",
                                                            "log_AvgReadDepth_tot",
                                                            "AvgReadDepth_MT",
                                                            "log_AvgReadDepth_MT",
                                                            "AvgReadLength"),
                             ordered = T)

####
# y-axis to meaningful numbers (i.e., 10^10, 10^4, etc...)

# one plot in linear scale, another in log

stats_to_plot %>%
ggplot(  aes(x = SM, y = value)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, size = 10),           
        
        strip.text.x = element_text(size = 12)) +
  facet_wrap(facets = vars(name), scales = "free_y",
             ncol = 3)  +
  labs(x = NULL, y = NULL)
```

### Plots with summary statistics
```{r, eval = F}

prepare_stats <- function(myPath){
  myStats <- read.csv(myPath, stringsAsFactors = F)
  myStats <- myStats[order(myStats$AvgReadDepth_tot),]
  myStats$SM <- factor(myStats$SM, levels = unique(myStats$SM), ordered = T)
  stats_to_plot <- myStats %>% 
    mutate(log_reads_raw = log10(reads_raw),
           log_reads_trim = log10(reads_trim),
           log_mapping = log10(mapping),
           log_duplicates = log10(duplicates),
           log_mapping_final = log10(mapping_final),
           log_endo_prop = log10(endo_prop),
           log_endo_final_prop = log10(endo_final_prop)) %>% 
    gather( name, value,  -SM, -low_ry, -high_ry, -Nseqs, 
            -NchrY.NchrX, -NchrY, -SE, -Sex, -X95.CI, -Sample) 
  
  # stats_to_plot$value <- as.numeric(stats_to_plot$value)
  
  stats_to_plot$name <- factor(stats_to_plot$name, 
                               levels = c("reads_raw", "log_reads_raw",
                                          "reads_trim", "log_reads_trim", "trim_prop",
                                          "mapping", "log_mapping",
                                          "duplicates", "log_duplicates", "duplicates_prop",
                                          "mapping_final", "log_mapping_final",
                                          "R_y",
                                          "endo_prop", "log_endo_prop",
                                          "endo_final_prop", "log_endo_final_prop",
                                          "AvgReadDepth_tot", "log_AvgReadDepth_tot",
                                          "AvgReadDepth_MT", "log_AvgReadDepth_MT",
                                          "AvgReadLength"),
                               ordered = T)
  return(stats_to_plot)
}
####
# y-axis to meaningful numbers (i.e., 10^10, 10^4, etc...)

# one plot in linear scale, another in log
path_trim <- "~/Projects/Botocudos/Files/Summaries/2019_11_21/Trimmed/myStats.csv"
path_whole <- "~/Projects/Botocudos/Files/Summaries/2019_11_21/Whole/myStats.csv"

whole <- prepare_stats(path_whole)
whole$type <- "Untrimmed"
trim <- prepare_stats(path_trim)
trim$type <- "Trimmed"
myDF <- rbind(whole, trim)

myDF$type <- factor(myDF$type, levels = c("Untrimmed", "Trimmed"), ordered = T)

myDF %>%
ggplot(  aes(x = SM, y = value, fill = type)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, size = 10),           
        strip.text.x = element_text(size = 12)) +
  facet_wrap(facets = vars(name), scales = "free_y",
             ncol = 3)  +
  labs(x = NULL, y = NULL) +
  scale_fill_discrete()



for(myCol in unique(myDF$name)){
  myPath <- paste("~/Projects/Botocudos/Plots/Sequencing/2020_02_25/comparison_",
                  myCol, ".png", sep = "")
  
  p <- ggplot(myDF[myDF$name == myCol, ],aes(x = SM, y = value, fill = type)) +
    geom_bar(stat = "identity", position = position_dodge()) +
    labs(title = myCol) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, size = 16, hjust = 1),           
          axis.text.y = element_text(size = 14),
          plot.title = element_text(size = 18, face = "bold", hjust = 0.5)) +
    labs(x = NULL, y = NULL) +
    scale_fill_discrete() 
  png(myPath, width = 9, height = 6, res = 250, bg = NA, units = "in")
  print(p)
  dev.off()
}

for(myCol in unique(whole$name)){
  myPath <- paste("~/Projects/Botocudos/Plots/Sequencing/2020_02_25/whole_",
                  myCol, ".png", sep = "")
  
  p <- ggplot(whole[whole$name == myCol, ],aes(x = SM, y = value, fill = type)) +
    geom_bar(stat = "identity", position = position_dodge(), fill = "salmon") +
    labs(title = myCol) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, size = 16, hjust = 1),           
          axis.text.y = element_text(size = 14),
          plot.title = element_text(size = 18, face = "bold", hjust = 0.5)) +
    labs(x = NULL, y = NULL) 
    
  png(myPath, width = 9, height = 6, res = 250, bg = NA, units = "in")
  print(p)
  dev.off()
}


for(myCol in unique(trim$name)){
  myPath <- paste("~/Projects/Botocudos/Plots/Sequencing/2020_02_25/trim_",
                  myCol, ".png", sep = "")
  
  p <- ggplot(trim[trim$name == myCol, ],aes(x = SM, y = value, fill = type)) +
    geom_bar(stat = "identity", position = position_dodge(), fill = "turquoise3") +
    labs(title = myCol) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, size = 16, hjust = 1),           
          axis.text.y = element_text(size = 14),
          plot.title = element_text(size = 18, face = "bold", hjust = 0.5)) +
    labs(x = NULL, y = NULL) 
    
  png(myPath, width = 9, height = 6, res = 250, bg = NA, units = "in")
  print(p)
  dev.off()
}
```

## Supplementary Table 2: Mapping stats per library

```{r}
myColNames <- read.csv("~/Projects/Botocudos/Files/Tables/Caption_ST2.csv",
                       stringsAsFactors = F)

lib_stats <- read.csv("~/Projects/Botocudos/Files/Summaries/2019_11_21/Whole/library_stats.hg19.csv")
sm_stats <- myStats

bamdamage_path <- paste("~/Projects/Botocudos/Files/bamdamage/2020_01_23/",
                        data_type, sep = "")

myT2 <- merge_stats_libs ( sm_stats, lib_stats, myColNames, backbone,
                           bamdamage_path =  bamdamage_path )

myT2 <- myT2[ ! myT2$Sample %in% c("MN0008_non_U", "MN0008_L3U"), ]

#------------------------------------------------------------------------------#
# Put things in Excel
column_styles <- list(trim_prop               = list(numFmt = "0.0%"),
                      duplicates_prop         = list(numFmt = "0.0%"),
                      reads_raw               = list(numFmt = "COMMA"),
                      reads_trim              = list(numFmt = "COMMA"),
                      mapping                 = list(numFmt = "COMMA"),
                      duplicates              = list(numFmt = "COMMA"),
                      mapping_final           = list(numFmt = "COMMA"),
                      endo_prop               = list(numFmt = "#0.00%"),
                      endo_final_prop         = list(numFmt = "#0.00%"),
                      length_reads_endogenous = list(numFmt = "0.0")
                      )
sheet_name <- paste("Sup_T2_", data_type, sep = "")

df <- myT2
caption <- get_caption( myT1 = myT2, myColNames = myColNames )

add_new_sheet(sheet_name = sheet_name, workbook = workbook, header_style = F,
              df = df, column_styles = column_styles,
              caption = caption, color_by_sample = T
              )
# openXL(file =  workbook)
# saveWorkbook(wb = workbook, file = workbook_name, overwrite = TRUE)
```

```{r, eval = F}
# kable(myT2_final, row.names = F, digits = 1)
myT2_final %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = list('excel', "csv")),
    rownames = F)

```


## Supplementary Table 3: Contamination estimates

```{r}
#------------------------------------------------------------------------------#
# add results from contaminationX
contaminationX_path <- "~/Projects/Botocudos/Files/Contamination/2020_01_24/contaminationX/"
males_estimate <- prepare_contaminationX_table(contaminationX_path = contaminationX_path,
                                               samples_libs = myT2,
                                               samples_sex = myT1)
#------------------------------------------------------------------------------#
# add results from schmutzi
schmutzi_path <- "~/Projects/Botocudos/Files/Contamination/2020_01_24/schmutzi/"
schmutzi_estimate <- get_schmutzi_table(schmutzi_path = schmutzi_path)
schmutzi_estimate
#------------------------------------------------------------------------------#
# add results from contamMix
map_path <- "~/Projects/Botocudos/Files/Contamination/2020_01_24/contamMix/estimates.txt"
contamMix_path <- "~/Projects/Botocudos/Files/Contamination/2020_01_24/contamMix/"
samples <- unique(myT2$Sample)
contamMix_estimate_all <- get_contamMix_table(contamMix_path = contamMix_path,
                                          map_path = map_path,
                                          samples = samples,
                                          rmTrans = "all")
contamMix_estimate_rmTrans <- get_contamMix_table(contamMix_path = contamMix_path,
                                          map_path = map_path,
                                          samples = samples,
                                          rmTrans = "rmTrans")

colnames(contamMix_estimate_all) <- sub("contamMix_estimate", 
                                        "contamMix_est_all",
                                        colnames(contamMix_estimate_all))
colnames(contamMix_estimate_all) <- sub("num_reads_contamMix", 
                                        "num_reads_contamMix_all",
                                        colnames(contamMix_estimate_all))
colnames(contamMix_estimate_rmTrans) <- sub("contamMix_estimate",
                                            "contamMix_est_rmTrans",
                                            colnames(contamMix_estimate_rmTrans))
colnames(contamMix_estimate_rmTrans) <- sub("num_reads_contamMix", 
                                        "num_reads_contamMix_rmTrans",
                                        colnames(contamMix_estimate_rmTrans))

contamMix_estimate_all[,c("Library", "damage")] <- NULL
contamMix_estimate_rmTrans[,c("Library", "damage")] <- NULL

#------------------------------------------------------------------------------#
# 
contamination <- join(contamMix_estimate_all,
                      contamMix_estimate_rmTrans,
                      by = "Sample")
contamination <- join(contamination, 
                      males_estimate[males_estimate$Library == "All",],
                       by = "Sample", type = "full")

# contamination <- join(contamination,
                      # schmutzi_estimate, by = "Sample")

contamination[,c("Library", "X_min_depth")] <- NULL
contamination <- join( contamination,
                       myT1[,c("Sample", "Sex", "DoC_MT")], 
                       by = "Sample" )
#------------------------------------------------------------------------------#
# haplogroups
mt_schmutzi <- read.table("~/Projects/Botocudos/Files/Haplogroups/2020_01_23/schmutzi_haplogrep/haplogroups_schmutzi.txt")
mt_data <- read.table("~/Projects/Botocudos/Files/Haplogroups/2020_01_23/haplogroups.txt")
y_data <- read.table("~/Projects/Botocudos/Files/Haplogroups/2020_01_23/Y/haplogroups_Y.txt")
y_coverage <- read.table("~/Projects/Botocudos/Files/Haplogroups/2020_01_23/Y/Y_depth.txt")
x_coverage <- read.table("~/Projects/Botocudos/Files/Contamination/2020_01_24/contaminationX/X_depth.txt")

colnames(mt_schmutzi) <- c("Sample", "endo_schmutzi", "cont_schmutzi")
colnames(mt_data) <- c("Sample", "rmTrans", "mt_haplogroup")
colnames(y_data) <- c("Sample", "y_haplogroup")
colnames(y_coverage) <- c("Sample", "DoC_Y")
colnames(x_coverage) <- c("Sample", "DoC_X")
contamination <- join(contamination, mt_data[mt_data$rmTrans == "all",
                                             c("Sample", "mt_haplogroup")], by = "Sample")
# contamination <- join(contamination, mt_schmutzi, by = "Sample")
contamination <- join(contamination, y_data, by = "Sample")
contamination <- join(contamination, y_coverage, by = "Sample")
contamination <- join(contamination, x_coverage, by = "Sample")

write.csv(contamination, "~/Projects/Botocudos/Files/Tables/Sup_T3.csv")
```


```{r}
#------------------------------------------------------------------------------#
# 

myColNames <- read.csv("~/Projects/Botocudos/Files/Tables/Caption_ST3.csv",
                       stringsAsFactors = F)

column_styles <- list(
                      contaminationX_num_sites    = list(numFmt = "COMMA"),
                      num_reads_contamMix_all     = list(numFmt = "COMMA"),
                      num_reads_contamMix_rmTrans = list(numFmt = "COMMA"),
                      reads_all_contamMix         = list(numFmt = "COMMA"),
                      reads_rmTrans_contamMix     = list(numFmt = "COMMA"),
                      
                      DoC_MT                      = list(numFmt = "0.0"),
                      DoC_Y = list(numFmt = "0.000")
                      )
sheet_name <- paste("Sup_T3_", data_type, sep = "")
colnames(contamination) <- sapply(colnames(contamination), 
                           function(name) change_name(name) )
  
df <-  reduce_order_columns(myTable = contamination, 
                           myColnames = myColNames)
caption <- get_caption( myT1 = contamination, myColNames = myColNames )

add_new_sheet(sheet_name = sheet_name, workbook = workbook, header_style = F,
              df = df, column_styles = column_styles,
              caption = caption, color_by_sample = T
              )
openXL(workbook)
saveWorkbook(wb = workbook, file = workbook_name, overwrite = TRUE)
# removeWorksheet(workbook, sheet = sheet_name)
```

```{r, eval = F}
kable(males_estimate, row.names = F)
```

```{r add results from contammix, eval=F}
prefix <- "~/Projects/Botocudos/Files/Contamination/2020_01_24/contamMix/"
samples <- samples_order
samples <- samples[!samples %in% c("MN0008_non_U", "MN0008_L3U")]
rmTrans <- c("all", "rmTrans")

# We ran the chains for 100k iterations, 
# we will subsample a fraction of these samples to plot the posterior distribution

subsample_contammmix <- function(path, sample, rmTrans, size = 100, lib = "All",
                                 burnIn = 0.1){

    myRda <- paste(path, sample, "/", s, ".hg19_", lib, "_", rmTrans, ".Rdata", sep = "")

  print(myRda)
  load(myRda)
  notBurnIn <- as.integer(burnIn*size)
  tiny <- # sample(
    #remove burnin
    c(res$chains[[1]][size - ((size- notBurnIn):0),2])#,
                 #res$chains[[2]][,2], res$chains[[3]][,2])#, size)
  result <- data.frame(estimate = tiny, damage = rmTrans, lib = lib,
                       sample = sample)
  return(result)
}

# contammix <- data.frame()
# for(s in samples){
#   libs <- (myT2$LB[myT2$SM == s])
#   for(l in libs){
#     for(r in rmTrans){
#       tmp_contam <- subsample_contammmix(prefix, s, r, 100000, l)
#       contammix <- rbind(contammix, tmp_contam)
#     }
#   }
# }


#------------------------------------------------------------------------------#
# Order libraries and save (or load) results
# contammix$lib <- factor(contammix$lib,
#                         levels = c("L1", "L2", "L3U", "mtCapture","All"), 
#                         ordered = T)
# contammix$coverage <- 0
# for(s in unique(contammix$sample)){
#   for(l in unique(contammix$lib[contammix$sample == s])){
#     contammix$coverage <- boto$hits_coverage_mitochondrial[boto$sample == s & boto$library == l]
#   }
# }

# save(contammix, file="~/Projects/Botocudos/Files/Contamination/2020_01_24/contamMix//contamination.Rdata")
load("~/Projects/Botocudos/Files/Contamination/2020_01_24/contamMix/contamination.Rdata")


path <- "~/Projects/Botocudos/Files/Contamination/2020_01_24/contamMix/"
rmTrans <- c("all", "rmTrans")
annot_mito <- data.frame()

for(s in samples){
  libs <- (myT2$LB[myT2$SM == s])
  for(lib in libs){
    for(r in rmTrans){
      myRda <- paste(path, s, "/", s, ".hg19_", lib, "_", r, ".Rdata", sep = "")
      #print(myRda)
      load(myRda)
      nReads <- dim(res$mnMatrix)[1]
      # coverage <- boto$hits_coverage_mitochondrial[boto$sample == s & boto$library == lib]
      annot_tmp <- data.frame(nReads = nReads, #coverage = coverage, 
                              damage = r, lib = lib,
                           sample = s)
      
      annot_mito <- rbind(annot_mito, annot_tmp)
    }
  }
}



MAP <- read.csv("~/Projects/Botocudos/Files/Contamination/2020_01_24/contamMix/estimates.txt", header = F)

colnames(MAP) <- c("sample", "lib", "damage","map", "low", "high")
MAP$lib <- sub("S1", "L1", MAP$lib)
annot_mito <- join(annot_mito, MAP, by = c("sample", "lib", "damage"))

```

```{r print estimates from contamMix, eval = F}

kable(mito, row.names = F)
```

```{r add results from schmutzi, eval=F}
path <- "~/Projects/Botocudos/Files/Contamination/2020_01_24/schmutzi/"

schmutzi_files <- list.files(path, pattern =".est")

schmutzi <- data.frame()

for(f in schmutzi_files){
  tmp_schmutzi <- read.table(paste(path, f, sep =""))
  colnames(tmp_schmutzi) <- c("estimate", "low", "up")
  tmp_schmutzi$sample <- strsplit(f, "_")[[1]][1]
  schmutzi <- rbind(schmutzi, tmp_schmutzi)
  
}
```

```{r print estimates from schmutzi, eval = F}
kable(schmutzi, row.names = F)
```

```{r}
myAccuracy <- 1

# contamMix
mito <- annot_mito[annot_mito$lib == "All" & annot_mito$damage == "all",]
mito$damage <- NULL
mito$lib <- NULL
colnames(mito) <- c("contamMix_num_reads", "Sample", 
                    "contamMix_estimate", "contamMix_low", "contamMix_up")

mito$contamMix_estimate <- percent(1 - mito$contamMix_estimate, accuracy = myAccuracy)
mito$contamMix_low <- percent(1 - mito$contamMix_low, accuracy = myAccuracy)
mito$contamMix_up <- percent(1 - mito$contamMix_up, accuracy = myAccuracy)
mito$contamMix_estimate <- paste(mito$contamMix_estimate, 
                                 " (", mito$contamMix_up, 
                                 ", ", mito$contamMix_low, ")", sep = "")
mito <- mito[, c("Sample", "contamMix_num_reads", "contamMix_estimate")]


# schmutzi
mito_sch <- schmutzi
colnames(mito_sch ) <- c("schmutzi_estimate", "schmutzi_low", "schmutzi_up", "Sample")
mito_sch$schmutzi_estimate <- percent(mito_sch$schmutzi_estimate, accuracy = myAccuracy)
mito_sch$schmutzi_low <- percent(mito_sch$schmutzi_low, accuracy = myAccuracy)
mito_sch$schmutzi_up <- percent(mito_sch$schmutzi_up, accuracy = myAccuracy)
mito_sch$schmutzi_estimate <- paste(mito_sch$schmutzi_estimate, 
                                    " (", mito_sch$schmutzi_low, 
                                    ", ",mito_sch$schmutzi_up, ")", sep = "")
mito_sch <- mito_sch[,c("Sample", "schmutzi_estimate")]

# contaminationX
x <- males_fmt[males_fmt$X_min_depth == 3,]
x$library <- NULL
x$X_method <- NULL
x$sex <- NULL
x$X_error <- NULL
x$X_min_depth <- NULL
colnames(x) <- c("contaminationX_estimate", "contaminationX_low", 
                 "contaminationX_up", "contaminationX_num_sites", "Sample")
x$contaminationX_estimate <-  paste(x$contaminationX_estimate, 
                                    " (", x$contaminationX_low, 
                                    ", ",x$contaminationX_up, ")", sep = "")
x <- x[,c("Sample", "contaminationX_estimate")]

# Merge
cont <- join(myT1[,c("Sample", "Sex")], mito, by = "Sample")
cont <- join(cont, mito_sch, by = "Sample")
cont <- join(cont, x, by = "Sample")

# kable(cont, row.names = F)

cont %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = list('excel', "csv")),
    rownames = F)
```

To see the usage of a project:
11:15
$id username ( Ex for me: $id rhofmeis)
it outputs: "uid=81418(rhofmeis) gid=11000(unil-empl-u-g) groups=11000(unil-empl-u-g),144375(ci-dcsr-infra-hpc-curentuser-u-g),149163(pi_odelanea_100241-pr-g),149411(heqtl_100247-pr-g),149412(glcoex_100246-pr-g),150304(poo_100286-pr-g),149410(impute_low_cov_seq_100248-pr-g)"
Before each project name, there is a PROJECT_NUMBER (For impute_low_cov it's 149410)
2.  run $beegfs-ctl --cfgFile=/etc/beegfs/beegfs-client-beegfs3.axiom.unil.ch.conf --getquota --gid PROJECT_NUMBER

## Supplementary Table 4: Haplogroups?

!!!
Haplogroups called (whenever it was possible)
cleaning and gathering output from haplogrep and David's script
!!!

```{r parse mt-haplogroups}
myPath <- "~/Projects/Botocudos/Files/Haplogroups/2020_01_23/"
hap_files <- list.files(myPath, pattern = ".haplo$")
mt_hap <- data.frame()

for(f in hap_files){
  tmp_hap <- read.table(paste(myPath, f, sep = ""), header = T)
  s <- sub(".haplo", "", f)
  tmp_hap$Sample <- s
  mt_hap <- rbind(mt_hap, tmp_hap)
  }

mt_hap <- mt_hap[,c("Sample", "Haplogroup")]


y_hap <- data.frame(Sample = c("MN0003",
                               "MN00064",
                               "MN00067",
                               "MN0008",
                               "MN0009",
                               "MN00346"),
                    Haplogroup = c("Q1a2a1-L54",
                                   "Q1a2a1a1-M3",
                                   "Q1a2a1a1-M3",
                                   "Q1a2a1a1-M3",
                                   "Q1a2a1a1-M3",
                                   "Q1a2a1a1-M3"))

myHaplos <- join(myT1[,c("Sample", "Sex")], mt_hap, by = "Sample")
myHaplos <- join(myHaplos, y_hap, by = "Sample")

kable(myHaplos, row.names = F)
```

## Length

Lots of plots per library, merged in one pdf

```{r}
# Function to fill in gaps in data frame (counts equaal to zero)
fill_gaps <- function(le){
  mySeq <- seq(min(le$length), max(le$length))
  mySeq <- mySeq[!mySeq %in% le$length]
  myGap <- data.frame(length = mySeq, counts = 0)
  new_le <- join(le, myGap, by = c("length", "counts"), "full")
  new_le <- new_le[order(new_le$length),]
  return(new_le)
}
```

```{r load files per sample}
myPath <- paste("~/Projects/Botocudos/Files/bamdamage/2020_01_23/",
                data_type, sep = "")

samples <- as.character(myStats$SM[order(myStats$AvgReadDepth_tot, decreasing = T)])
if(!"MN0008_L3U" %in% samples){
  samples <- c(samples, "MN0008_L3U", "MN0008_non_U")  
}
myLength <- vector("list", length = length(samples))
names(myLength) <- samples

for(s in samples){
  path_length <- paste(myPath, s, sep = "/")
  path_length <- paste(path_length, "/", s, ".hg19.length.csv", sep = "")
  tmp_length <- read.csv(path_length)
  myLength[[s]] <- tmp_length
  }   


```

```{r plots per sample, eval = T, fig.width=16, fig.height=16}
myColor <- "royalblue"
nCol <- 6
samples_per_row <- ceiling(length(samples)/nCol)
cex <- 1.1

blank_plot <- function(){
  plot(1,1, type = "n", bty = "n", axes = F, xlab = NA, ylab = NA)
}

pdf(paste("~/Projects/Botocudos/Plots/Sequencing/Length_dist_",
          data_type,".pdf", sep = ""),
    width = 12, height = 12)
layout(matrix(seq(1, nCol*samples_per_row), ncol = nCol, byrow = T))

for(s in samples){
    le <- myLength[[s]]
    plot.title <- s
    myMean <- round(sum(le$length*le$counts)/sum(le$counts), 1)
    barplot(le$counts/sum(le$counts), space = 0,
         col = myColor, bty = "n", 
         xlab = "Length", ylab = "Frequency", border = NA,
         main = plot.title, lwd = 0.2)
    axis(1, at= seq(0.5, nrow(le), 5), 
         labels = seq(min(le$length), max(le$length), 5))
    text(20, 0.9*max(le$counts/sum(le$counts)), 
         labels = paste("Mean: ", myMean, " bp", sep = ""),
        cex = 0.8)
    abline(v = myMean-20, lty = "dashed")
}

dev.off()
```

```{r load files per library}
myPath <- paste("~/Projects/Botocudos/Files/bamdamage/2020_01_23/",
                data_type,"/", sep = "")

myLength <- vector("list", length = length(samples))
names(myLength) <- samples

for(s in samples){
  myLibs <- lib_st$LB[lib_st$SM == s]
  some_length <- vector("list", length = length(myLibs))
  names(some_length) <- myLibs
  
  for(l in myLibs){
    path_length <- paste(myPath, s, l, "library_bamdamage", sep = "/")
    path_length <- paste(path_length, "/", l, ".hg19.length.csv", sep = "")
    tmp_length <- read.csv(path_length)
    some_length[[l]] <- tmp_length
  }
  myLength[[s]] <- some_length
  }


```

```{r plots per library, eval = F}
myColor <- "royalblue"
nCol <- max(sapply(myLength, length))
samples_per_page <- 5
cex <- 1.2

blank_plot <- function(){
  plot(1,1, type = "n", bty = "n", axes = F, xlab = NA, ylab = NA)
}

pdf(paste("~/Projects/Botocudos/Plots/Sequencing/Length_dist_libs_",data_type,".pdf",sep = ""),
    width = 9, height = 12)
layout(matrix(seq(samples_per_page*nCol), nrow = samples_per_page, byrow = T))

for(s in samples){
  myLibs <- lib_st$LB[lib_st$SM == s]
  myRow <- which(samples == s)
  
  if(!myRow %% samples_per_page){
    # plot.new()
    layout(matrix(seq(samples_per_page*nCol), nrow = samples_per_page, byrow = T))  
  }
  
  for(l in myLibs){
    le <- myLength[[s]][[l]]
    # le <- le[le$counts >0,]
    
    plot.title <- paste(s, l)
    barplot(le$counts/sum(le$counts), space = 0,
         col = myColor, bty = "n", 
         xlab = "Length", ylab = "Frequency", #border = "white",
         main = plot.title, lwd = 0.2)
    axis(1, at= seq(0.5, nrow(le)-0.5, 5), 
         labels = seq(min(le$length), max(le$length), 5))
  }
  plots_left <- nCol - length(myLibs)
  while(plots_left > 0){
    blank_plot()
    plots_left <- plots_left - 1
  }
}

dev.off()



```

## Damage

Lots of plots per library, merged in one pdf

```{r load damage per sample}
myPath <- paste("~/Projects/Botocudos/Files/bamdamage/2020_01_23/", data_type, sep = "")

if(!"MN0008_L3U" %in% samples){
  samples <- c(samples, "MN0008_L3U", "MN0008_non_U")  
}

myDam <- vector("list", length = length(samples))
names(myDam) <- samples

for(s in samples){
  path_dam <- paste(myPath, s, sep = "/")
  path_dam <- paste(path_dam, "/", s, ".hg19.dam_5prime.csv", sep = "")
  tmp_dam5 <- read.csv(path_dam)
  path_dam <- sub("5prime", "3prime", path_dam)
  tmp_dam3 <- read.csv(path_dam)
  
  some_dam <- list(five_prime = tmp_dam5, three_prime = tmp_dam3)
  myDam[[s]] <- some_dam
}


```

```{r plot damage per sample, eval=T, fig.width=16, fig.height=16, eval = F}
nCol <- 8
nRow <- 7
cex <- 1.2

blank_plot <- function(){
  plot(1:10,1:10, type = "n", bty = "n", axes = F, xlab = NA, ylab = NA)
}

pdf(paste("~/Projects/Botocudos/Plots/Sequencing/Damage_", data_type, ".pdf", sep = ""),
    width = 14, height = 12)
layout(matrix(seq(nCol*nRow), ncol = nCol, byrow = T))

for(s in samples){
    y2 <- 0.35
    plot.title <- s
    five_prime <- myDam[[s]][["five_prime"]]
    three_prime <- myDam[[s]][["three_prime"]]
    plot_bamdamage(five_prime = five_prime, three_prime = three_prime, 
                  cex = 1, 
                  y2 = y2, plot.title = plot.title,
                  myColor = c())
}
plot_bamdamage(legend_only = T,
                  myColor = c(),
               legend_cex = 1, ncol_legend = 3)

dev.off()
```


```{r load damage per library, eval = F}
myPath <- paste("~/Projects/Botocudos/Files/bamdamage/2020_01_23/", data_type,"/", sep = "")

myDam <- vector("list", length = length(samples))
names(myDam) <- samples

for(s in samples){
  myLibs <- lib_st$LB[lib_st$SM == s]
  some_dam <- vector("list", length = length(myLibs))
  names(some_dam) <- myLibs
  
  for(l in myLibs){
    path_dam <- paste(myPath, s, l, "library_bamdamage", sep = "/")
    path_dam <- paste(path_dam, "/", l, ".hg19.dam_5prime.csv", sep = "")
    tmp_dam5 <- read.csv(path_dam)
    path_dam <- sub("5prime", "3prime", path_dam)
    tmp_dam3 <- read.csv(path_dam)
    
    some_dam[[l]] <- list(five_prime = tmp_dam5, three_prime = tmp_dam3)
  }
  myDam[[s]] <- some_dam
  }


```

```{r plot damage per library, eval=F}
nCol <- max(sapply(myDam, length))
samples_per_page <- 5
cex <- 1.2

blank_plot <- function(){
  plot(1:10,1:10, type = "n", bty = "n", axes = F, xlab = NA, ylab = NA)
}

pdf(paste("~/Projects/Botocudos/Plots/Sequencing/Damage_lib_", data_type, ".pdf", sep = ""),
    width = 12, height = 12)
layout(matrix(seq(samples_per_page*nCol*2), nrow = samples_per_page, byrow = T))

for(s in samples){
  myLibs <- lib_st$LB[lib_st$SM == s]
  myRow <- which(samples == s)
  
  if(!myRow %% samples_per_page){
    # plot.new()
    layout(matrix(seq(samples_per_page*nCol*2), nrow = samples_per_page, byrow = T))  
  }
  
  for(l in myLibs){
    y2 <- 0.35
    le <- myDam[[s]][[l]][["five_prime"]]
    
    plot.title <- paste(s, l)
    par(mar = c(4, 3, 3, 1))
    plot(le$C..T[1:25], type = "b",
         col = myColor_CT, bty = "n", 
         xlab = "5' position", ylab = "Frequency", lwd = 1.5, 
         main = plot.title, cex = cex, axes = F, ylim = c(0, y2))
    axis(side = 1, at = seq(0,25,5))
    axis(side=2)
    
    le <- myDam[[s]][[l]][["three_prime"]]
    par(mar = c(4,1,3,3))
    plot(rev(le$G..A[1:25]), type = "b",
         col = myColor_GA, bty = "n", 
          lwd = 1.5, 
         cex = cex, axes = F, xlab = "3' position", ylab = NA, ylim = c(0, y2))
     axis(side = 1, at = seq(1,25,5), labels = seq(25, 1,-5))
     axis(side = 4)
  }
  plots_left <- nCol*2 - length(myLibs)*2
  while(plots_left > 0){
    blank_plot()
    plots_left <- plots_left - 1
  }

}

  legend(1,10, legend = c("C -> T", "G -> A"), col = c(myColor_CT, myColor_GA),
       lty = 1, pch = 21, bty = "n", cex = 2)
# blank_plot()


dev.off()
```

```{r compare errors for MN00013, eval = F}
# collect statistics from bamdamage for untrimmed and trimmed dataset
read_types <- c("Whole", "Trimmed")
myDam <- vector("list", length = 2)
for(data_type in read_types){
  myPath <- paste("~/Projects/Botocudos/Files/bamdamage/2020_01_23/", 
                  data_type, sep = "")
  
  names(myDam) <- c("MN0008_non_U", "MN00013")
  
  # Compare problematic sample and a "control" (MN00013, and MN0008_non_U)
  for(s in c("MN0008_non_U", "MN00013")){
    path_dam <- paste(myPath, s, sep = "/")
    path_dam <- paste(path_dam, "/", s, ".hg19.dam_5prime.csv", sep = "")
    tmp_dam5 <- read.csv(path_dam)
    path_dam <- sub("5prime", "3prime", path_dam)
    tmp_dam3 <- read.csv(path_dam)
    tmp_dam5$data_type <- data_type
    tmp_dam3$data_type <- data_type
    some_dam <- list(five_prime = tmp_dam5, three_prime = tmp_dam3)
    myDam[[s]][["five_prime"]] <- rbind(myDam[[s]][["five_prime"]],tmp_dam5 ) #<- some_dam
    myDam[[s]][["three_prime"]] <- rbind(myDam[[s]][["three_prime"]],tmp_dam3 )
    }
}
```

```{r, eval = F}
reshape_sample <- function(sample, read_end){
  damage <- myDam[[sample]][[read_end]] %>%
    gather(damage_type, value, -data_type)
  damage$read_end <- read_end
  damage$sample <- sample
  return(damage)
}
mn8 <- lapply(c("three_prime", "five_prime"), 
              function(x) reshape_sample("MN0008_non_U", read_end =  x))
mn13 <- lapply(c("three_prime", "five_prime"), 
              function(x) reshape_sample("MN00013", read_end =  x))

damage <- do.call(rbind,c(mn13,mn8))
damage <- damage %>% subset(damage_type != "X") 


# Maximum lengths are 81 and 71 bp for untrimmed and trimmed dataset, 
# respectively
myPath <- "~/Projects/Botocudos/Files/bamdamage/2020_01_23/"
get_mean <- function(sample, data_type, damage_type, read_end = "five_prime"){
  if ( data_type == "Trimmed" ) {
    indexes <- 1:71
  } else {
    indexes <- 1:80
  }
  read_lengths <- read.csv(paste(myPath, data_type, "/", sample, "/", sample, 
                                 ".hg19.length.csv", sep = ""))
  read_lengths$cumsum_reads <- rev(cumsum(rev(read_lengths$counts)))
  read_lengths <- rbind(data.frame(length = seq(1,20),
                                   counts = 0,
                                   cumsum_reads = read_lengths$cumsum_reads[1]),
                        read_lengths)
  sum_errors <- sum( damage[damage$data_type == data_type
                            & damage$damage_type == damage_type 
                            & damage$sample == sample 
                            & damage$read_end == read_end,]$value[indexes] 
                     * read_lengths$cumsum_reads[indexes] )
  mean_error <- sum_errors / sum( read_lengths$length[indexes]
                                  * read_lengths$counts[indexes] )
  return(mean_error)
}

errors <- data.frame()

for ( sample in c("MN00013", "MN0008_non_U") ){
  for( data_type in c("Trimmed", "Whole") ){
    trimmed_error <- sapply( unique(damage$damage_type),
                             function(x) get_mean( sample = sample, 
                                                   data_type = data_type,
                                                   read_end = "three_prime",
                                                   damage_type = x ) )
    trimmed_error <- as.data.frame(t(trimmed_error))
    trimmed_error$sample <- sample
    trimmed_error$data_type <- data_type
    errors <- rbind(errors, trimmed_error)
  }
}

errors$data_type <- factor(errors$data_type, 
                          levels = c("Whole", "Trimmed"),
                          ordered = T)
```

```{r, eval = F}

pdf("~/Projects/Botocudos/Plots/Error/MN00013_MN0008_comparison_bammds.pdf",
    width = 7, height = 7)
errors %>% 
  gather(name, value, -sample, -data_type) %>%
  mutate(name = sub("\\.\\.", " to ", name)) %>%
  ggplot(aes(x = sample, y = value, fill = data_type )) +
  geom_bar(stat = "identity", position = position_dodge()) +
  facet_wrap(.~name, ncol = 3) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, size = 9, hjust = 1, vjust = 0.5)) +
  scale_fill_discrete() +
  labs(y = "Error rate", x = NULL, 
       title = "Type-specific error rates (data from bammds)") +
  scale_y_continuous(labels = percent)
dev.off()
```

```{r, eval = F}

damage_whole_trimmed <- function(sample, damage_type, read_end, col){
  plot( damage$value[damage$sample == sample 
                     & damage$data_type == "Whole" &
                       damage$read_end == read_end &
                       damage$damage_type == damage_type],
        type = "l", lwd = 2, 
        col = col, 
        ylab = "Frequency", xlab = read_end, 
        main = paste(sub("\\.\\.", " to ", damage_type), ", ", sample),
        bty = "n")
  
  lines(x = 6:75,
        damage$value[damage$sample == sample 
                     & damage$data_type == "Trimmed" &
                       damage$read_end == read_end &
                       damage$damage_type == damage_type][1:70],
        lty = "dashed", col = col, lwd = 2)
}

pdf("~/Projects/Botocudos/Plots/Error/MN00013_MN0008_damage_curves.pdf",
    width = 7, height = 8)
layout( matrix( seq( 1,4 ), byrow = T, ncol = 2 ) )
damage_whole_trimmed(sample = "MN00013", damage_type = "C..T",
                     read_end = "five_prime", col = "blue")
damage_whole_trimmed(sample = "MN00013", damage_type = "G..A",
                     read_end = "three_prime", col = "red")
damage_whole_trimmed(sample = "MN0008_non_U", damage_type = "C..T",
                     read_end = "five_prime", col = "blue")
damage_whole_trimmed(sample = "MN0008_non_U", damage_type = "G..A",
                     read_end = "three_prime", col = "red")
legend( 40, 0.15, bty = "n", lty = c("solid", "dashed"), 
        legend = c("Whole", "Trimmed"))
dev.off()
```

```{r, eval = F}
cumulative_damage <- function(sample, read_end, damage_type, col){
  plot( cumsum( damage$value[damage$sample == sample 
                             & damage$data_type == "Whole" &
                               damage$read_end == read_end &
                               damage$damage_type == damage_type] ),
        type = "l", lwd = 2, 
        col = col, 
        ylab = "Cumulative error per base", xlab = read_end, 
        main = paste(sub("\\.\\.", " to ", damage_type), ", ", sample),
        bty = "n")
  
  lines(
    cumsum( damage$value[damage$sample == sample 
                         & damage$data_type == "Trimmed" &
                           damage$read_end == read_end &
                           damage$damage_type == damage_type][1:71] ),
    lty = "dashed", col = col, lwd = 2)
} 

pdf("~/Projects/Botocudos/Plots/Error/MN00013_MN0008_cumulative_damage.pdf",
    width = 7, height = 8)
layout( matrix( seq( 1,4 ), byrow = T, ncol = 2 ) )
cumulative_damage(sample = "MN00013", damage_type = "C..T",
                     read_end = "five_prime", col = "blue")
cumulative_damage(sample = "MN00013", damage_type = "G..A",
                     read_end = "three_prime", col = "red")
cumulative_damage(sample = "MN0008_non_U", damage_type = "C..T",
                     read_end = "five_prime", col = "blue")
cumulative_damage(sample = "MN0008_non_U", damage_type = "G..A",
                     read_end = "three_prime", col = "red")
legend( 40, 0.6, bty = "n", lty = c("solid", "dashed"), 
        legend = c("Whole", "Trimmed"))
dev.off()
```

